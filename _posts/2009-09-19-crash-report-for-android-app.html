---
layout: post
title: "Crash report for Android App"
date: 2009-09-19
comments: false
categories:
 - crash
 - android
---

<div class='post'>
To err is human and to crash is the software created by human (even if it is made for Android ;)<br /><div><br /></div><div>So when your app crashes on your users' phones, it's a good idea to collect the details of the crash and prompt the user to send them to you. I recently wrote one such scheme for ReaderScope and it has been very helpful. Here is how I am doing it.</div><div><br /></div><div>I found the code snippets after googling around. Mainly from this <a href="http://stackoverflow.com/questions/601503/how-do-i-obtain-crash-data-from-my-android-application">stackoverflow article</a>. This morning however, I added few more bits to work well with exceptions that take place in background threads.</div><div><br /></div><div>The way to do this is to implement the <a href="http://developer.android.com/reference/java/lang/Thread.UncaughtExceptionHandler.html">Thread.UncaughtExceptionHandler</a> interface and pass it to <a href="http://developer.android.com/reference/java/lang/Thread.html#setUncaughtExceptionHandler(java.lang.Thread.UncaughtExceptionHandler)">Thread.setDefaultUncaughtExceptionHandler()</a> at the beginning of your Activity's onCreate(). Here is the implementation class TopExceptionHandler.</div><div id="main_code"><pre><span style="color: #ff40ff;">package</span> com.altcanvas.readerscope;<br /><br /><span style="color: #ff40ff;">import</span> android.app.Activity;<br /><span style="color: #ff40ff;">import</span> android.app.AlertDialog;<br /><span style="color: #ff40ff;">import</span> android.content.DialogInterface;<br /><span style="color: #ff40ff;">import</span> android.content.Context;<span class="Apple-style-span" style="color: #ff40ff;"><br /></span><span style="color: #ff40ff;">import</span> java.io.*;<br /><br /><span style="color: #8080ff;"><b>public</b></span> <span style="color: #8080ff;"><b>class</b></span> TopExceptionHandler <span style="color: #8080ff;"><b>implements</b></span> Thread.UncaughtExceptionHandler {<br /><br /><span style="color: #8080ff;"><b>private</b></span> Thread.UncaughtExceptionHandler defaultUEH;<br /><br /><span style="color: #8080ff;"><b>private</b></span> Activity app = <span style="color: lime;">null</span>;<br /><br /><span style="color: #8080ff;"><b>public</b></span> TopExceptionHandler<span class="c188">(</span>Activity app<span class="c188">)</span> {<br /><span style="color: #8080ff;"><b>this</b></span>.defaultUEH = Thread.getDefaultUncaughtExceptionHandler<span class="c188">()</span>;<br /><span style="color: #8080ff;"><b>this</b></span>.app = app;<br />}<br /><br /><span style="color: #8080ff;"><b>public</b></span> <span style="color: #8080ff;"><b>void</b></span> uncaughtException<span class="c188">(</span>Thread t, Throwable e<span class="c188">)</span><br />{<br />StackTraceElement<span class="c188">[]</span> arr = e.getStackTrace<span class="c188">()</span>;<br />String report = e.toString<span class="c188">()</span>+<span style="color: lime;">"</span><span style="color: #ff6060;"><b>\n\n</b></span><span style="color: lime;">"</span>;<br />report += <span style="color: lime;">"--------- Stack trace ---------</span><span style="color: #ff6060;"><b>\n\n</b></span><span style="color: lime;">"</span>;<br /><span style="color: #8080ff;"><b>for</b></span> <span class="c188">(</span><span style="color: #8080ff;"><b>int</b></span> i=<span style="color: lime;">0</span>; i&lt;arr.length; i++<span class="c188">)</span><br />{<br />report += <span style="color: lime;">"    "</span>+arr<span class="c188">[</span>i<span class="c188">]</span>.toString<span class="c188">()</span>+<span style="color: lime;">"</span><span style="color: #ff6060;"><b>\n</b></span><span style="color: lime;">"</span>;<br />}<br />report += <span style="color: lime;">"-------------------------------</span><span style="color: #ff6060;"><b>\n\n</b></span><span style="color: lime;">"</span>;<br /><br /><span style="color: #ff6060;">// If the exception was thrown in a background thread inside</span><br /><span style="color: #ff6060;">// AsyncTask, then the actual exception can be found with getCause</span><br />report += <span style="color: lime;">"--------- Cause ---------</span><span style="color: #ff6060;"><b>\n\n</b></span><span style="color: lime;">"</span>;<br />Throwable cause = e.getCause<span class="c188">()</span>;<br /><span style="color: #8080ff;"><b>if</b></span><span class="c188">(</span>cause != <span style="color: lime;">null</span><span class="c188">)</span> {<br />report += cause.toString<span class="c188">()</span> + <span style="color: lime;">"</span><span style="color: #ff6060;"><b>\n\n</b></span><span style="color: lime;">"</span>;<br />arr = cause.getStackTrace<span class="c188">()</span>;<br /><span style="color: #8080ff;"><b>for</b></span> <span class="c188">(</span><span style="color: #8080ff;"><b>int</b></span> i=<span style="color: lime;">0</span>; i&lt;arr.length; i++<span class="c188">)</span><br />{<br />report += <span style="color: lime;">"    "</span>+arr<span class="c188">[</span>i<span class="c188">]</span>.toString<span class="c188">()</span>+<span style="color: lime;">"</span><span style="color: #ff6060;"><b>\n</b></span><span style="color: lime;">"</span>;<br />}<br />}<br />report += <span style="color: lime;">"-------------------------------</span><span style="color: #ff6060;"><b>\n\n</b></span><span style="color: lime;">"</span>;<br /><br /><span style="color: #8080ff;"><b>try</b></span> {<br />FileOutputStream trace = app.openFileOutput<span class="c188">(</span><br /><span style="color: lime;">"stack.trace"</span>, Context.MODE_PRIVATE<span class="c188">)</span>;<br />trace.write<span class="c188">(</span>report.getBytes<span class="c191">()</span><span class="c188">)</span>;<br />trace.close<span class="c188">()</span>;<br />} <span style="color: #8080ff;"><b>catch</b></span><span class="c188">(</span>IOException ioe<span class="c188">)</span> {<br />// ...<br />}<br /><br />defaultUEH.uncaughtException<span class="c188">(</span>t, e<span class="c188">)</span>;<br />}<br />}</pre></div><div class="credits"><br /></div><div class="credits">Note that we are not consuming the exception. We let the Android framework's defaultUEH to handle it. If you don't do this, <a href="http://groups.google.com/group/android-developers/browse_thread/thread/c32e8c6120bed5c5">bad things may happen</a>.</div><div class="credits"><br /></div>At the top of your Activity register an instance of above class like this:<br /><pre><span style="color: #ff40ff;">@Override</span><br /><span style="color: #8080ff;"><b>public</b></span> <span style="color: #8080ff;"><b>void</b></span> onCreate<span class="c188">(</span>Bundle savedInstanceState<span class="c188">)</span><br />{<br /><span style="color: #8080ff;"><b>super</b></span>.onCreate<span class="c188">(</span>savedInstanceState<span class="c188">)</span>;<br /><br />Thread.setDefaultUncaughtExceptionHandler<span class="c188">(</span><span style="color: #8080ff;"><b>new</b></span> TopExceptionHandler<span class="c191">(</span><span style="color: #8080ff;"><b>this</b></span><span class="c191">)</span><span class="c188">)</span>;<br /></pre><pre>...</pre><div><br /></div><div>This exception handler saves the trace in a file. When ReaderScope restarts next time, it detects the file and prompts the user if he/she wants to email it to the developer.</div><div><br /></div><div>Emailing the stack trace with user's consent is so much easier on Android, than setting up a crash report server. Somewhere near the beginning of your activity just check if stack.trace file is present. If so, execute following code to pack it in an email.<span class="Apple-style-span" style="font-family: monospace; font-size: 13px; white-space: pre;"> </span></div><div id="main_code"><pre><span style="color: #8080ff;"><b>try</b></span> {<br />BufferedReader reader = <span style="color: #8080ff;"><b>new</b></span> BufferedReader<span class="c188">(</span><br /><span style="color: #8080ff;"><b>new</b></span> InputStreamReader<span class="c191">(</span>ReaderScopeActivity.<span style="color: #8080ff;"><b>this</b></span><br />.openFileInput<span class="c193">(</span><span style="color: lime;">"stack.trace"</span><span class="c193">)</span><span class="c191">)</span><span class="c188">)</span>;<br /><span style="color: #8080ff;"><b>while</b></span><span class="c188">(</span><span class="c191">(</span>line = reader.readLine<span class="c193">()</span><span class="c191">)</span> != <span style="color: lime;">null</span><span class="c188">)</span> {<br />trace += line+<span style="color: lime;">"</span><span style="color: #ff6060;"><b>\n</b></span><span style="color: lime;">"</span>;<br />}<br />} <span style="color: #8080ff;"><b>catch</b></span><span class="c188">(</span>FileNotFoundException fnfe<span class="c188">)</span> {<br /><span style="color: #ff6060;">// ...</span><br />} <span style="color: #8080ff;"><b>catch</b></span><span class="c188">(</span>IOException ioe<span class="c188">)</span> {<br /><span style="color: #ff6060;">// ...</span><br />}<br /><br />Intent sendIntent = <span style="color: #8080ff;"><b>new</b></span> Intent<span class="c188">(</span>Intent.ACTION_SEND<span class="c188">)</span>;<br />String subject = <span style="color: lime;">"Error report"</span>;<br />String body =<br /><span style="color: lime;">"Mail this to readerscope@altcanvas.com: "</span>+<br /><span style="color: lime;">"</span><span style="color: #ff6060;"><b>\n\n</b></span><span style="color: lime;">"</span>+<br />trace+<br /><span style="color: lime;">"</span><span style="color: #ff6060;"><b>\n\n</b></span><span style="color: lime;">"</span>;<br /><br />sendIntent.putExtra<span class="c188">(</span>Intent.EXTRA_EMAIL,<br /><span style="color: #8080ff;"><b>new</b></span> String<span class="c191">[]</span> {<span style="color: lime;">"readerscope@altcanvas.com"</span>}<span class="c188">)</span>;<br />sendIntent.putExtra<span class="c188">(</span>Intent.EXTRA_TEXT, body<span class="c188">)</span>;<br />sendIntent.putExtra<span class="c188">(</span>Intent.EXTRA_SUBJECT, subject<span class="c188">)</span>;<br />sendIntent.setType<span class="c188">(</span><span style="color: lime;">"message/rfc822"</span><span class="c188">)</span>;<br /><br />ReaderScopeActivity.<span style="color: #8080ff;"><b>this</b></span>.startActivity<span class="c188">(</span><br />Intent.createChooser<span class="c191">(</span>sendIntent, <span style="color: lime;">"Title:"</span><span class="c191">)</span><span class="c188">)</span>;<br /><br />ReaderScopeActivity.<span style="color: #8080ff;"><b>this</b></span>.deleteFile<span class="c188">(</span><span style="color: lime;">"stack.trace"</span><span class="c188">)</span>;</pre><div><br /></div><div>Hope this helps! If you have suggestions for improvements, please do let me know in comments.</div><div><div></div></div><div><br /></div><div><i><span class="Apple-style-span" style="font-size: small;">code syntax highlighting by </span></i><a href="http://vim.sourceforge.net/" name="vimhome"><i><span class="Apple-style-span" style="font-size: small;">GVIM</span></i></a><i><span class="Apple-style-span" style="font-size: small;">, using the "delek" theme.</span></i><br /><i><span class="Apple-style-span" style="font-size: small;"><br /></span></i><br /><i><span class="Apple-style-span" style="font-size: small;"><span class="Apple-style-span" style="color: #666666;">Ads:</span></span></i><br /><i><span class="Apple-style-span" style="font-size: small;">*&nbsp;<a href="http://www.amazon.com/Professional-Android-2-Application-Development/dp/0470565527?ie=UTF8&amp;tag=myfreq-20&amp;link_code=btl&amp;camp=213689&amp;creative=392969" target="_blank">Professional Android 2 Application Development</a><img alt="" border="0" height="1" src="http://www.assoc-amazon.com/e/ir?t=myfreq-20&amp;l=btl&amp;camp=213689&amp;creative=392969&amp;o=1&amp;a=0470565527" style="border: none !important; margin: 0px !important; padding: 0px !important;" width="1" /></span></i><br /><i><span class="Apple-style-span" style="font-size: small;">*&nbsp;<a href="http://www.amazon.com/Android-Application-Development-Programming-Google/dp/0596521472?ie=UTF8&amp;tag=myfreq-20&amp;link_code=btl&amp;camp=213689&amp;creative=392969" target="_blank">Android Application Development: Programming with the Google SDK</a><img alt="" border="0" height="1" src="http://www.assoc-amazon.com/e/ir?t=myfreq-20&amp;l=btl&amp;camp=213689&amp;creative=392969&amp;o=1&amp;a=0596521472" style="border: none !important; margin: 0px !important; padding: 0px !important;" width="1" /></span></i><br /><i><span class="Apple-style-span" style="font-size: small;">*&nbsp;<a href="http://www.amazon.com/Coders-Guide-Advanced-Android-Development/dp/0981678017?ie=UTF8&amp;tag=myfreq-20&amp;link_code=btl&amp;camp=213689&amp;creative=392969" target="_blank">The Busy Coder's Guide to Advanced Android Development</a><img alt="" border="0" height="1" src="http://www.assoc-amazon.com/e/ir?t=myfreq-20&amp;l=btl&amp;camp=213689&amp;creative=392969&amp;o=1&amp;a=0981678017" style="border: none !important; margin: 0px !important; padding: 0px !important;" width="1" /></span></i></div></div></div>
<h2>Comments</h2>
<div class='comments'>
<div class='comment'>
<div class='author'>singh sumit</div>
<div class='content'>
hey,<br />in above comments I see a statement : &quot; When an exception is uncaught and goes trough your handler, if a second uncaught exception happens in your app, this second one is not get by the handler...&quot;<br /><br />Is there a way to reproduce this? Basically I want to see the case when exception is not caught by the handler. This is important for robustness in some cases. <br /></div>
</div>
<div class='comment'>
<div class='author'>Lavekush Agrawal</div>
<div class='content'>
but how can i get specified exception name..?<br />like java.lang.ArrayOutOfBounsException</div>
</div>
<div class='comment'>
<div class='author'>RAGHAV</div>
<div class='content'>
How can i kill the thread because when it gives the exception and when it go back to class files it hangs my application what can i do ?</div>
</div>
<div class='comment'>
<div class='author'>PanosJee</div>
<div class='content'>
You could use <a href="http://www.bugsense.com" rel="nofollow">BugSense</a>, it&#39;s really easy to setup and the reports are stunning.</div>
</div>
<div class='comment'>
<div class='author'>android mobile</div>
<div class='content'>
Latest reviews and news about android phones, free droid app and android mobile.</div>
</div>
<div class='comment'>
<div class='author'>Uncle Code Monkey</div>
<div class='content'>
I loved your article.  I have used something similar in my apps and have had wonderful results.  Thanks for sharing!<br /><br />My tweak to this method of error reporting was to make the handler send out the email intent immediately after writing the file to disk.  The trick is to make the class implement Runnable and put the code necessary to launch the email intent inside a run() method.  Then you call runOnUiThread(this) and while the dialog with the Force Close button is being shown to the user, 99% of the time the email app will launch behind it ready to send the crash report.<br /><br />e.g.<br />public class pmreHandler implements UncaughtExceptionHandler, Runnable {<br /><br />  public pmreHandler(Activity aApp) {<br />    mDefaultUEH = Thread.getDefaultUncaughtExceptionHandler();<br />    mApp = aApp;<br />  }<br /><br />  @Override<br />  public void uncaughtException(Thread t, Throwable e) {<br />    submit(e);<br />    //do not forget to pass this exception through up the chain<br />        mDefaultUEH.uncaughtException(t,e);<br />  }<br /><br />  @Override<br />  public void run() {<br />    sendDebugReportToAuthor();<br />  }<br /> <br />  public void submit(Throwable e) {<br />    String theErrReport = getDebugReport(e);<br />    saveDebugReport(theErrReport);<br />    //try to send file contents via email (need to do so via the UI thread)<br />    mApp.runOnUiThread(this);<br />  }<br />}<br /><br />You can check out my full source code (with link back to here) at <br />http://blog.blackmoonit.com/2010/02/android-postmortem-reports-via-email.html</div>
</div>
<div class='comment'>
<div class='author'>Donal Morrissey</div>
<div class='content'>
I&#39;ve found a &#39;hack&#39; to get around this:<br /><br />@Override<br />public void onCreate(Bundle savedInstanceState){<br />super.onCreate(savedInstanceState);<br />this.gEH = new GlobalExceptionHandler(this);<br /><br />//Check if there is a crash report and if so, send email intent.<br />Boolean hasCrashed = this.gEH.checkForCrashAndHandle();<br /><br />if(hasCrashed == true)<br />{<br /> try {<br />  Thread.sleep(3000);<br /> } catch (InterruptedException e) {<br />  // TODO Auto-generated catch block<br />  e.printStackTrace();<br /> }<br />}<br /><br />Thread.setDefaultUncaughtExceptionHandler(this.gEH);<br /><br />//Cause exception<br />int var = 10 / 0;<br /><br />// Do Ui Stuff<br />...<br />...<br /><br />}<br /><br /><br />If I don&#39;t put in the Thread sleep, then the exception will cause the UI thread to stop, resulting in the Intent to send the email not being carried out. Even though I know that my uncaughtException handler is being called and the intent for the email started. <br /><br />Not a neat solution, but as Intents can&#39;t block the UI thread and I don&#39;t think you can start an &#39;independent&#39; Intent, then I can&#39;t think of any other possible solutions.<br />Don</div>
</div>
<div class='comment'>
<div class='author'>Jayesh</div>
<div class='content'>
&gt; There is one loop-hole with the solution, that is if you have an exception with your app when it is being created (i.e. in onCreate or onStart, etc), the email intent will not get sent!<br /><br />That&#39;s true. The check if stack.trace exists or not should be done as early in onCreate() as possible. And whatever little code that runs before that check can be well tested to not have any bug leading to crash. I think that&#39;s not very difficult to ensure.</div>
</div>
<div class='comment'>
<div class='author'>Jayesh</div>
<div class='content'>
&gt; When an exception is uncaught and goes trough your handler, if a second uncaught exception happens in your app, this second one is not get by the handler...<br /><br />That&#39;s true. Once you get report of first exception, fix it, release new version. The other exception might be reported next time.<br /><br />Ideally we should test our app against all of the crash scenarios before releasing it. But practially that&#39;s not possible. This crash report is a safety net for that. You will be saved if one crash scenario slips your testing, but you shouldn&#39;t rely on it to catch all your crashes.</div>
</div>
<div class='comment'>
<div class='author'>Donal Morrissey</div>
<div class='content'>
Hi Jayesh,<br />Great Job, really useful.<br />May be of benefit to add the following to the report as it&#39;s often helpful to know:<br /><br />report += &quot;-------------------------------\n\n&quot;;<br />        report += &quot;--------- Device ---------\n\n&quot;;<br />        report += &quot;Brand: &quot; + Build.BRAND + &quot;\n&quot;;<br />        report += &quot;Device: &quot; + Build.DEVICE + &quot;\n&quot;;<br />        report += &quot;Model: &quot; + Build.MODEL + &quot;\n&quot;;<br />        report += &quot;Id: &quot; + Build.ID + &quot;\n&quot;;<br />        report += &quot;Product: &quot; + Build.PRODUCT + &quot;\n&quot;;<br />        report += &quot;-------------------------------\n\n&quot;;<br />        report += &quot;--------- Firmware ---------\n\n&quot;;<br />        report += &quot;SDK: &quot; + Build.VERSION.SDK + &quot;\n&quot;;<br />        report += &quot;Release: &quot; + Build.VERSION.RELEASE + &quot;\n&quot;;<br />        report += &quot;Incremental: &quot; + Build.VERSION.INCREMENTAL + &quot;\n&quot;;<br />        report += &quot;-------------------------------\n\n&quot;;<br /><br /><br />There is one loop-hole with the solution, that is if you have an exception with your app when it is being created (i.e. in onCreate or onStart, etc), the email intent will not get sent!<br />Can you please confirm this? Is there any way around it?<br />Cheers,<br />Don</div>
</div>
<div class='comment'>
<div class='author'>Jbeer</div>
<div class='content'>
Yes, I have set it in the main Activity and works for all App. I have realized something, I dont know if the same happens to you:<br />When an exception is uncaught and goes trough your handler, if a second uncaught exception happens in your app, this second one is not get by the handler... <br />Its like &quot;Ok, this thread is dead, and no longer used&quot;...</div>
</div>
<div class='comment'>
<div class='author'>Jayesh</div>
<div class='content'>
&gt; The &quot;Thread.setDefaultUncaughtExceptionHandler...&quot; line have to be placed at the beggining of every Activity you have in the App?<br /><br />I think this call directly affects the VM. (I recall reading it somewhere, but can&#39;t find where). What that means is, any activity or service in your app that runs after this call, will have your default uncaught exception handler to fall back to, provided your app&#39;s process (and hence the VM running inside it) is not killed by the framework.<br /><br />If your app has multiple entry points, i.e. if you have two activities, but user may use only one of them and never invoke the other, then you will have to do this registration in both activities. However in that scenario, to not leak the TopExceptionHandler instance, you may want to make it singleton.</div>
</div>
<div class='comment'>
<div class='author'>Jbeer</div>
<div class='content'>
Hi Jayesh.<br /><br />Great article!<br /><br />Just I wanted to know. The &quot;Thread.setDefaultUncaughtExceptionHandler...&quot; line have to be placed at the beggining of every Activity you have in the App?</div>
</div>
</div>
