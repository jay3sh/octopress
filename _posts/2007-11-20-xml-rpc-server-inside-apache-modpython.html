---
layout: post
title: "XML RPC server inside apache mod_python"
date: 2007-11-20
comments: false
categories:
 - python xmlrpc apache
---

<div class='post'>
Writing XML RPC server and client in python is extremely easy. There are many examples. <a href="http://docs.python.org/lib/module-xmlrpclib.html"><span style="font-style: italic;">xmlrpclib</span></a> is part of python, so writing client doesn't need anything extra. There are many examples of XMLRPC server as well. I used <a href="http://www.julien-oster.de/projects/xmlrpcserver/">Julien Oster's</a>.<br /><br />The problem comes when you want to use XML RPC server in a production environment alongside your apache web server. If you are not a big shop then you very likely want to host both of them on same machine. Then two different servers can't listen for HTTP on same port. You might use an alternate port (second in popularity to port 80), but the users behind corporate firewall will suffer. If you understand the protocol stack, you would know it shouldn't be difficult to run the XMLRPC server inside an apache server. I realized that last weekend, and in couple of hours I hosted Julien Oster's XML RPC server inside my apache mod_python framework.<br /><br /><a href="http://www.julien-oster.de/projects/xmlrpcserver/">Download</a> the XML RPC server. You will find a single file xmlrpcserver.py.<br /><br />You will find a class XmlRpcServer in it. That's all you need. Add following method to it:<br /><pre><strong>   <span style="color: rgb(255, 0, 0);"> def</span><span style="color: rgb(255, 0, 0);"> handle</span><span style="color: rgb(32, 64, 160);">(self,req)</span>:<br /></strong>        <span style="color: rgb(32, 64, 160);">length</span> <span style="color: rgb(68, 68, 255);">=</span> <span style="color: rgb(32, 64, 160);">int</span><span style="color: rgb(68, 68, 255);">(</span><span style="color: rgb(32, 64, 160);">req</span>.<span style="color: rgb(32, 64, 160);">headers_in</span><span style="color: rgb(68, 68, 255);">[</span><span style="color: rgb(0, 128, 0);">"Content-length"</span><span style="color: rgb(68, 68, 255);">]</span><span style="color: rgb(68, 68, 255);">)</span><br /><br />     <span style="color: rgb(32, 64, 160);">request_string</span> <span style="color: rgb(68, 68, 255);">=</span> <span style="color: rgb(32, 64, 160);">req</span>.<span style="color: rgb(32, 64, 160);">read</span><span style="color: rgb(68, 68, 255);">(</span><span style="color: rgb(32, 64, 160);">length</span><span style="color: rgb(68, 68, 255);">)</span><br />     <span style="color: rgb(32, 64, 160);">request</span> <span style="color: rgb(68, 68, 255);">=</span> <span style="color: rgb(32, 64, 160);">StringIO</span><span style="color: rgb(68, 68, 255);">(</span><span style="color: rgb(32, 64, 160);">request_string</span><span style="color: rgb(68, 68, 255);">)</span><br /><br />     <span style="color: rgb(32, 64, 160);">request</span>.<span style="color: rgb(32, 64, 160);">seek</span><span style="color: rgb(68, 68, 255);">(</span><span style="color: rgb(255, 0, 0);">0</span><span style="color: rgb(68, 68, 255);">)</span><br />     <span style="color: rgb(32, 64, 160);">response</span> <span style="color: rgb(68, 68, 255);">=</span> <span style="color: rgb(32, 64, 160);">StringIO</span><span style="color: rgb(68, 68, 255);">(</span><span style="color: rgb(68, 68, 255);">)</span><br /><br />     <strong>try</strong><span style="color: rgb(68, 68, 255);">:</span><br />         <span style="color: rgb(32, 64, 160);">self</span>.<span style="color: rgb(32, 64, 160);">execute</span><span style="color: rgb(68, 68, 255);">(</span><span style="color: rgb(32, 64, 160);">request</span>, <span style="color: rgb(32, 64, 160);">response</span>, <span style="color: rgb(32, 64, 160);">None</span><span style="color: rgb(68, 68, 255);">)</span><br />     <strong>except</strong> <span style="color: rgb(32, 64, 160);">Exception</span>, <span style="color: rgb(32, 64, 160);">e</span><span style="color: rgb(68, 68, 255);">:</span><br /><br />         <strong>return</strong> <span style="color: rgb(32, 64, 160);">apache</span>.<span style="color: rgb(32, 64, 160);">HTTP_INTERNAL_SERVER_ERROR</span><br />     <strong>finally</strong><span style="color: rgb(68, 68, 255);">:</span><br />        <span style="color: rgb(32, 64, 160);">response</span>.<span style="color: rgb(32, 64, 160);">seek</span><span style="color: rgb(68, 68, 255);">(</span><span style="color: rgb(255, 0, 0);">0</span><span style="color: rgb(68, 68, 255);">)</span><br /><br />        <span style="color: rgb(32, 64, 160);">rstr</span> <span style="color: rgb(68, 68, 255);">=</span> <span style="color: rgb(32, 64, 160);">response</span>.<span style="color: rgb(32, 64, 160);">read</span><span style="color: rgb(68, 68, 255);">(</span><span style="color: rgb(68, 68, 255);">)</span><br />        <span style="color: rgb(32, 64, 160);">req</span>.<span style="color: rgb(32, 64, 160);">headers_out</span><span style="color: rgb(68, 68, 255);">[</span><span style="color: rgb(0, 128, 0);">'Content-type'</span><span style="color: rgb(68, 68, 255);">]</span> <span style="color: rgb(68, 68, 255);">=</span> <span style="color: rgb(0, 128, 0);">'text/xml'</span><br /><br />        <span style="color: rgb(32, 64, 160);">req</span>.<span style="color: rgb(32, 64, 160);">headers_out</span><span style="color: rgb(68, 68, 255);">[</span><span style="color: rgb(0, 128, 0);">'Content-length'</span><span style="color: rgb(68, 68, 255);">]</span> <span style="color: rgb(68, 68, 255);">=</span> <span style="color: rgb(0, 128, 0);">"%d"</span><span style="color: rgb(68, 68, 255);">%</span><span style="color: rgb(32, 64, 160);">len</span><span style="color: rgb(68, 68, 255);">(</span><span style="color: rgb(32, 64, 160);">rstr</span><span style="color: rgb(68, 68, 255);">)</span><br /><br />        <span style="color: rgb(32, 64, 160);">req</span>.<span style="color: rgb(32, 64, 160);">write</span><span style="color: rgb(68, 68, 255);">(</span><span style="color: rgb(32, 64, 160);">rstr</span><span style="color: rgb(68, 68, 255);">)</span><br />        <strong>return</strong> <span style="color: rgb(32, 64, 160);">apache</span>.<span style="color: rgb(32, 64, 160);">OK</span> <br /></pre><br />Now host the following code in your index.py file (or any python file you have configured as PythonHandler in your apache settings)<br /><pre><br /><strong>from</strong> <span style="color: rgb(32, 64, 160);">mod_python</span> <strong>import</strong> <span style="color: rgb(32, 64, 160);">apache</span><br /><br /><strong>from</strong> <span style="color: rgb(32, 64, 160);">xmlrpcserver</span> <strong>import</strong> <span style="color: rgb(32, 64, 160);">XmlRpcServer</span><br /> <br /><strong><span style="color: rgb(255, 0, 0);">def</span> <span style="color: rgb(255, 0, 0);">handler</span><span style="color: rgb(68, 68, 255);">(</span><span style="color: rgb(32, 64, 160);">req</span><span style="color: rgb(68, 68, 255);">)</span></strong><span style="color: rgb(68, 68, 255);">:</span><br /><br /> <strong>try</strong><span style="color: rgb(68, 68, 255);">:</span><br />     <span style="color: rgb(32, 64, 160);">xmlserver</span> <span style="color: rgb(68, 68, 255);">=</span> <span style="color: rgb(32, 64, 160);">XmlRpcServer</span><span style="color: rgb(68, 68, 255);">(</span><span style="color: rgb(68, 68, 255);">)</span><br />     <span style="color: rgb(32, 64, 160);">app</span> <span style="color: rgb(68, 68, 255);">=</span> <span style="color: rgb(32, 64, 160);">Application</span><span style="color: rgb(68, 68, 255);">(</span><span style="color: rgb(68, 68, 255);">)</span><br /><br />     <span style="color: rgb(32, 64, 160);">xmlserver</span>.<span style="color: rgb(32, 64, 160);">register_class</span><span style="color: rgb(68, 68, 255);">(</span><span style="color: rgb(0, 128, 0);">'app'</span>,<span style="color: rgb(32, 64, 160);">app</span><span style="color: rgb(68, 68, 255);">)</span><br />         <br />     <span style="color: rgb(32, 64, 160);">result</span> <span style="color: rgb(68, 68, 255);">=</span> <span style="color: rgb(32, 64, 160);">xmlserver</span>.<span style="color: rgb(32, 64, 160);">handle</span><span style="color: rgb(68, 68, 255);">(</span><span style="color: rgb(32, 64, 160);">req</span><span style="color: rgb(68, 68, 255);">)</span><br /><br />     <strong>return</strong> <span style="color: rgb(32, 64, 160);">result</span><br /> <strong>except</strong> <span style="color: rgb(32, 64, 160);">Exception</span>, <span style="color: rgb(32, 64, 160);">e</span><span style="color: rgb(68, 68, 255);">:</span><br />     <strong>return</strong> <span style="color: rgb(32, 64, 160);">apache</span>.<span style="color: rgb(32, 64, 160);">HTTP_INTERNAL_SERVER_ERROR</span><br /><br /><span style="color: rgb(68, 68, 68);"># The following class is where you can put your application logic</span><br /><strong>class</strong> <span style="color: rgb(32, 64, 160);">Application</span><span style="color: rgb(68, 68, 255);">:</span><br /><strong>   <span style="color: rgb(255, 0, 0);"> def</span><span style="color: rgb(255, 0, 0);"> __init__</span><span style="color: rgb(32, 64, 160);">(self)</span>:<br /></strong>        <strong>pass</strong><br /><br /><strong>   <span style="color: rgb(255, 0, 0);"> def</span><span style="color: rgb(255, 0, 0);"> getName</span><span style="color: rgb(32, 64, 160);">(self)</span>:<br /></strong>        <strong>return</strong> <span style="color: rgb(0, 128, 0);">'example'</span><br /></pre><br />Once you save the above index.py to your webserver, you can use a python client to invoke XMLRPC calls to your apache server.<br /><br />Assuming you saved above file to $(DOCROOT)/xmlrpc/index.py, your client code would look like this:<br /><pre><strong>import</strong> <span style="color: rgb(32, 64, 160);">xmlrpclib</span><br /><br /><span style="color: rgb(32, 64, 160);">remote</span> <span style="color: rgb(68, 68, 255);">=</span> <span style="color: rgb(32, 64, 160);">xmlrpclib</span>.<span style="color: rgb(32, 64, 160);">Server</span><span style="color: rgb(68, 68, 255);">(</span><span style="color: rgb(0, 128, 0);">'http://yourserver.com/xmlrpc/'</span><span style="color: rgb(68, 68, 255);">)</span><br /><span style="color: rgb(32, 64, 160);">name</span> <span style="color: rgb(68, 68, 255);">=</span> <span style="color: rgb(32, 64, 160);">remote</span>.<span style="color: rgb(32, 64, 160);">app</span>.<span style="color: rgb(32, 64, 160);">getName</span><span style="color: rgb(68, 68, 255);">(</span><span style="color: rgb(68, 68, 255);">)</span><br /></pre><br /><br />And you are all set!<br /><br /><span style="font-size:78%;">syntax highlighted by <a href="http://www.palfrader.org/code2html">Code2HTML</a></span></div>
<h2>Comments</h2>
<div class='comments'>
<div class='comment'>
<div class='author'>Anonymous</div>
<div class='content'>
Hey... newbie here trying to implement a simple xmlrpc server on apache with mod_python. I tried the first method did not work. The one offered by josh there&#39;s a webpage that displays a title, func1() returns foo and listallmethods. Was wondering what to do from here to say have a client call methods from the server and display in a page ?</div>
</div>
<div class='comment'>
<div class='author'>Anonymous</div>
<div class='content'>
@joss82 I don&#39;t need anything else really! Just curious about the differences in performance between both approaches. But your approach is working nicely for me at the moment. Thanks!<br /><br />p.s I might add support for system.methodHelp and system.methodSignature at a later stage and will post back here then.</div>
</div>
<div class='comment'>
<div class='author'>Joss82</div>
<div class='content'>
My bit should be enough to run a fully operational web service. You just need to change ExposedClass so it does what you want. What else do you need exactly?</div>
</div>
<div class='comment'>
<div class='author'>Anonymous</div>
<div class='content'>
I managed to do the bit that Joss82 posted, but couldn&#39;t do the original poster&#39;s method at all. Any help possible? thom_41 at (spamfree) yahoo.com</div>
</div>
<div class='comment'>
<div class='author'>Jayesh</div>
<div class='content'>
You guys might also like this other <A HREF="http://jyro.blogspot.com/2008/10/migrating-to-google-app-engine.html" REL="nofollow">post</A> I wrote about how to implement XML RPC server on top of Google App Engine.<BR/><BR/>The actual <A HREF="http://appengine-cookbook.appspot.com/recipe/xml-rpc-server-using-google-app-engine/" REL="nofollow">recipe</A> I wrote is in App engine docs' cookbook.<BR/><BR/>It is more attractive option because Google App engine is free to start and you can pay for more resources if traffic to your site exceeds. (I think the paying part is yet to be made public)</div>
</div>
<div class='comment'>
<div class='author'>Felipe</div>
<div class='content'>
thanks Jayesh Salvi and joss82, both examples worked like a charm, I will use joss82 implementation for production, but I will disable the list_methods option to avoid curious people</div>
</div>
<div class='comment'>
<div class='author'>joss82</div>
<div class='content'>
I have found a way to achieve the same functionality using only the xmlrpclib library, included in python 2.5<BR/>So you don&#39;t need to install any additional library. And it is self-documenting too if you access it from a web browser. Enjoy :<BR/><BR/>#!env python2.5<BR/># -*- coding:utf-8 -*-<BR/><BR/>from DocXMLRPCServer import ServerHTMLDoc<BR/>import xmlrpclib<BR/>from mod_python import apache<BR/><BR/>class ExposedClass:<BR/>    def __init__(self, foo = 42):<BR/>        self.foo = foo<BR/>    def exposed_func1(self):<BR/>        &quot;&quot;&quot;Returns &quot;foo&quot; &quot;&quot;&quot;<BR/>        return self.foo<BR/>    <BR/>def handler(req):<BR/>    exposed_instance = ExposedClass()<BR/>    all_methods = list_public_methods(exposed_instance)<BR/>    all_methods.append(&quot;system.listMethods&quot;)<BR/>    if req.method == &quot;GET&quot;:<BR/>        req.content_type = &quot;text/html; charset=UTF-8&quot;<BR/>        req.send_http_header()<BR/>        srv = ServerHTMLDoc()<BR/>        req.write(srv.docserver(&quot;XMLRPC server in Apache&quot;, &quot;&quot;, dict([(m,getattr(exposed_instance,m,None)) for m in all_methods]) ))<BR/>        return_val = apache.OK<BR/>    elif req.method == &quot;POST&quot;:<BR/>        data = req.read()<BR/>        if data == &quot;&quot;:<BR/>            req.content_type = &quot;text/html&quot;<BR/>            req.send_http_header()<BR/>            return_val = apache.HTTP_EXPECTATION_FAILED<BR/>        else:<BR/>            req.content_type = &quot;text/xml&quot;<BR/>            req.send_http_header()<BR/>            params, method = xmlrpclib.loads(data)<BR/>            <BR/>            if method == &quot;system.listMethods&quot;:<BR/>                req.write(xmlrpclib.dumps((all_methods,), methodresponse = True))<BR/>            else:<BR/>                if method in all_methods:<BR/>                    req.write(xmlrpclib.dumps((getattr(exposed_instance,method)(*params),), methodresponse = True, allow_none = True))<BR/>                else:<BR/>                    req.write(xmlrpclib.dumps(((-2, &quot;Unknown function : %s&quot; % str(method), &quot;&quot;,{}),), methodresponse = True, allow_none = True))<BR/>        return_val = apache.OK<BR/>    return return_val<BR/><BR/>def list_public_methods(obj):<BR/>    &quot;&quot;&quot;Returns a list of attribute strings, found in the specified<BR/>    object, which represent callable attributes&quot;&quot;&quot;<BR/><BR/>    return [member for member in dir(obj)<BR/>                if not member.startswith(&#39;_&#39;) and<BR/>                    callable(getattr(obj, member))]</div>
</div>
</div>
