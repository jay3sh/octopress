---
layout: post
title: "Android AsyncTask template"
date: 2009-11-19
comments: false
categories:
 - altcanvas
 - async
 - multithreading
 - GUI
 - android
 - readerscope
---

<div class='post'>
Any meaningful GUI application needs to employ multiple threads, otherwise it is very likely to lock while doing any I/O operations - leaving bad impression on the user. Same is true for Android apps. In fact, android framework prompts user to close the app if it doesn't respond in 10 seconds or so. So it's absolutely essential to perform any task - that has even a remote possibility of taking a bit longer - in a background thread.<br /><br />Fortunately Android framework has some useful constructs built into the framework that make our job relatively easy while doing multithreaded GUI programming. <a bitly="BITLY_PROCESSED" href="http://developer.android.com/reference/android/os/AsyncTask.html">android.os.AsyncTask</a> is one of them.<br /><br />The basic steps to make your app multithreaded using AsyncTask are as follows:<br />1. <b>Identify the code segment that you want to execute in background</b> thread. (for e.g. code that does network i/o, bulk file transfer on local disk, etc)<br /><br />2. <b>Model it as an AsyncTask object</b>.<br />(Subclass the AsyncTask object and put your code segment in the doInBackground(...) method)<br /><br />3. Figure out what <b>parameters</b> you have to pass to the task, the <b>result</b> that the task should return and how to handle the <b>exception</b> in case something goes wrong.<br /><br />This is pretty simple, but the third step gets bit complicated as your app grows and there are multiple asynchronous tasks that you want to code in.<br /><br />When I was faced with this problem during the development of <a bitly="BITLY_PROCESSED" href="http://www.altcanvas.com/android/cutewit">CuTewit</a>, I stumbled through some steps. After a while I managed to create a template for modelling with AsyncTasks. In my second app - <a bitly="BITLY_PROCESSED" href="http://www.altcanvas.com/android/readerscope">ReaderScope</a> - the same template worked very nicely. ReaderScope has over 50 different tasks that are run on background thread at one time or another. The template I use, has made it pretty easy to add new AsyncTasks.<br /><br />In this post, I want to share that template with you. I have written a small example app that demonstrates the use of the template. Download <a bitly="BITLY_PROCESSED" href="http://altcanvas.googlecode.com/files/asynctemplate.tar.gz">source tarball</a> and <a bitly="BITLY_PROCESSED" href="http://altcanvas.googlecode.com/files/AsyncTemplate.apk">apk</a> to try it yourself.<br /><br />Here is the source code of AppTask.java (the derivative of AsyncTask) for discussion.<br /><br /><div id="main_code"><pre><span style="color: #ff40ff;">package</span> com.altcanvas.asynctemplate;<br /><br /><span style="color: #ff40ff;">import</span> android.os.AsyncTask;<br /><br /><span style="color: #8080ff;"><b>public</b></span> <span style="color: #8080ff;"><b>class</b></span> AppTask <span style="color: #8080ff;"><b>extends</b></span> AsyncTask&lt;AppTask.Payload, Object, AppTask.Payload&gt;<br /><br />{<br />    <span style="color: #8080ff;"><b>public</b></span> <span style="color: #8080ff;"><b>static</b></span> <span style="color: #8080ff;"><b>final</b></span> String TAG = <span style="color: lime;">"AppTask"</span>;<br /><br />    <span style="color: #8080ff;"><b>public</b></span> <span style="color: #8080ff;"><b>static</b></span> <span style="color: #8080ff;"><b>final</b></span> <span style="color: #8080ff;"><b>int</b></span> APPTASK_1 = <span style="color: lime;">1001</span>;<br />    <span style="color: #8080ff;"><b>public</b></span> <span style="color: #8080ff;"><b>static</b></span> <span style="color: #8080ff;"><b>final</b></span> <span style="color: #8080ff;"><b>int</b></span> APPTASK_2 = <span style="color: lime;">1002</span>;<br /><br />    <span style="color: #ff6060;">/*</span><br /><span style="color: #ff6060;">     * Runs on GUI thread</span><br /><span style="color: #ff6060;">     */</span><br />    <span style="color: #8080ff;"><b>protected</b></span> <span style="color: #8080ff;"><b>void</b></span> onPreExecute() {<br />    }<br /><br />    <span style="color: #ff6060;">/*</span><br /><span style="color: #ff6060;">     * Runs on GUI thread</span><br /><span style="color: #ff6060;">     */</span><br />    <span style="color: #8080ff;"><b>public</b></span> <span style="color: #8080ff;"><b>void</b></span> onPostExecute(AppTask.Payload payload)<br />    {<br />        <span style="color: #8080ff;"><b>switch</b></span>(payload.taskType) {<br /><br />        <span style="color: #8080ff;"><b>case</b></span> APPTASK_1:<br />            AsyncTemplateActivity app =<br />                (AsyncTemplateActivity) payload.data[<span style="color: lime;">0</span>];<br /><br />            <span style="color: #8080ff;"><b>if</b></span>(payload.result != <span style="color: lime;">null</span>) {<br /><br />                <span style="color: #ff6060;">// Present the result on success</span><br /><br />                <span style="color: #8080ff;"><b>int</b></span> answer = ((Integer) payload.result).intValue();<br />                app.taskStatus.setText(<span style="color: lime;">"Success: answer = "</span>+answer);<br /><br />            } <span style="color: #8080ff;"><b>else</b></span> {<br />                <span style="color: #ff6060;">// Report the exception on failure</span><br /><br />                String msg = (payload.exception !=<span style="color: lime;">null</span>) ?<br />                                payload.exception.toString() : <span style="color: lime;">""</span>;<br />                app.taskStatus.setText(<span style="color: lime;">"Failure: error ="</span>+msg);<br />            }<br /><br />            <span style="color: #8080ff;"><b>break</b></span>;<br /><br />        <span style="color: #8080ff;"><b>case</b></span> APPTASK_2:<br />            <span style="color: #8080ff;"><b>break</b></span>;<br />        }<br />    }<br /><br />    <span style="color: #ff6060;">/*</span><br /><span style="color: #ff6060;">     * Runs on GUI thread</span><br /><span style="color: #ff6060;">     */</span><br />    <span style="color: #8080ff;"><b>public</b></span> <span style="color: #8080ff;"><b>void</b></span> onProgressUpdate(Object<span style="color: cyan;">...</span> value)<br /><br />    {<br />        <span style="color: #8080ff;"><b>int</b></span> type = ((Integer) value[<span style="color: lime;">0</span>]).intValue();<br /><br />        <span style="color: #8080ff;"><b>switch</b></span>(type) {<br /><br />        <span style="color: #8080ff;"><b>case</b></span> APPTASK_1:<br />            AsyncTemplateActivity app = (AsyncTemplateActivity) value[<span style="color: lime;">1</span>];<br />            <span style="color: #8080ff;"><b>int</b></span> progress = ((Integer) value[<span style="color: lime;">2</span>]).intValue();<br />            app.progressBar.setProgress(progress);<br />            <span style="color: #8080ff;"><b>break</b></span>;<br /><br />        <span style="color: #8080ff;"><b>case</b></span> APPTASK_2:<br />            <span style="color: #8080ff;"><b>break</b></span>;<br />        }<br /><br />    }<br /><br />    <span style="color: #ff6060;">/*</span><br /><span style="color: #ff6060;">     * Runs on background thread</span><br /><span style="color: #ff6060;">     */</span><br />    <span style="color: #8080ff;"><b>public</b></span> AppTask.Payload doInBackground(AppTask.Payload<span style="color: cyan;">...</span> params)<br /><br />    {<br />        AppTask.Payload payload = params[<span style="color: lime;">0</span>];<br /><br />        <span style="color: #8080ff;"><b>try</b></span> {<br />            <span style="color: #8080ff;"><b>switch</b></span>(payload.taskType) {<br />            <span style="color: #8080ff;"><b>case</b></span> APPTASK_1:<br /><br />                <span style="color: #ff6060;">// extract the parameters of the task from payload</span><br /><br />                AsyncTemplateActivity app =<br />                    (AsyncTemplateActivity) payload.data[<span style="color: lime;">0</span>];<br />                <span style="color: #8080ff;"><b>int</b></span> numSteps = ((Integer) payload.data[<span style="color: lime;">1</span>]).intValue();<br /><br />                <span style="color: #8080ff;"><b>if</b></span>(numSteps &lt; <span style="color: lime;">0</span>) <span style="color: #8080ff;"><b>throw</b></span> <span style="color: #8080ff;"><b>new</b></span> AppException(<span style="color: lime;">"Invalid input"</span>);<br /><br />                <span style="color: #ff6060;">// perform the task</span><br /><br />                <span style="color: #8080ff;"><b>int</b></span> progress = <span style="color: lime;">0</span>;<br />                <span style="color: #8080ff;"><b>for</b></span>(; progress &lt; numSteps; progress++) {<br />                    <span style="color: #8080ff;"><b>try</b></span> {<br />                        <span style="color: #ff6060;">// pretend to work for 1 second</span><br /><br />                        Thread.currentThread().sleep(<span style="color: lime;">1000</span>);<br />                    } <span style="color: #8080ff;"><b>catch</b></span>(InterruptedException ie) {<br />                        <span style="color: #8080ff;"><b>break</b></span>;<br />                    }<br />                    publishProgress(<span style="color: #8080ff;"><b>new</b></span> Object[] {<br />                            <span style="color: #8080ff;"><b>new</b></span> Integer(APPTASK_1), app, progress});<br />                }<br /><br />                publishProgress(<span style="color: #8080ff;"><b>new</b></span> Object[] {<br />                        <span style="color: #8080ff;"><b>new</b></span> Integer(APPTASK_1), app, progress});&nbsp;</pre><pre><span style="color: #ff6060;">                // Return result of the task</span><br />                payload.result = <span style="color: #8080ff;"><b>new</b></span> Integer(<span style="color: lime;">42</span>);<br />                <span style="color: #8080ff;"><b>break</b></span>;<br /><br />            <span style="color: #8080ff;"><b>case</b></span> APPTASK_2:<br />                <span style="color: #8080ff;"><b>break</b></span>;<br />            }<br />        } <span style="color: #8080ff;"><b>catch</b></span>(AppException ape) {<br />            payload.exception = ape;<br />            payload.result = <span style="color: lime;">null</span>;<br />        }<br /><br />        <span style="color: #8080ff;"><b>return</b></span> payload;<br />    }<br /><br />    <span style="color: #8080ff;"><b>public</b></span> <span style="color: #8080ff;"><b>static</b></span> <span style="color: #8080ff;"><b>class</b></span> Payload<br />    {<br />        <span style="color: #8080ff;"><b>public</b></span> <span style="color: #8080ff;"><b>int</b></span> taskType;<br />        <span style="color: #8080ff;"><b>public</b></span> Object[] data;<br />        <span style="color: #8080ff;"><b>public</b></span> Object result;<br />        <span style="color: #8080ff;"><b>public</b></span> Exception exception;<br /><br />        <span style="color: #8080ff;"><b>public</b></span> Payload(<span style="color: #8080ff;"><b>int</b></span> taskType, Object[] data) {<br />            <span style="color: #8080ff;"><b>this</b></span>.taskType = taskType;<br />            <span style="color: #8080ff;"><b>this</b></span>.data = data;<br />        }<br />    }<br />}<br /><br /></pre></div><div class="credits"><span style="font-size: xx-small;">code syntax highlighting by <a bitly="BITLY_PROCESSED" href="http://vim.sourceforge.net/" name="vimhome">GVIM</a>,</span><br /><br />Let's go over different aspects of this code.<br /><br /></div><b>What is Payload?</b> <br />To simplify the management of passing parameters and carrying result/exception back, we create a special object called Payload. Payload carries four entities - the type of the AsyncTask (int taskType), parameters to the task (Object[] data), result of the task (Object result), exception that took place during the task (Exception exception).<br /><br />Note the signatures of doInBackground and onPostExecute. The same payload object is passed around.<br /><br /><b>How do you start a new task?</b><br /><br /><pre><span style="color: #8080ff;"><b>new</b></span> AppTask().execute<span style="color: #8080ff;">(<b>new</b></span> AppTask.Payload(<br />    AppTask.APPTASK_1,<br /><span style="color: #8080ff;"><b>    new</b></span> Object[] { AsyncTemplateActivity.<span style="color: #8080ff;"><b>this</b></span>,<br /><span style="color: #8080ff;"><b>    new</b></span> Integer(numSteps) }));&nbsp;</pre><pre>&nbsp; &nbsp;<br /></pre>[You can find it in AsyncTemplateActivity.java in the sample app]<br /><br /><b>How do you define a new async task?</b><br />You don't have to create another AsyncTask derivative object. Just define a new taskType, e.g. APPTASK_2 in AppTask.java. Create a switch case for that taskType in each of 'doInBackground', 'onPostExecute', 'onProgressUpdate'. Depending upon the nature of the tasks, the contents of payload.data will vary. Since this data is passed as generic Object[], you can pass around any types of objects that suite the task's needs. On the other hand, you have to be careful to not type cast them to wrong classes. <br /><span style="font-size: x-small;">[We loose Java's static type checking by defining params and result as generic 'Object's. But it saves us from repetitively defining similar AsyncTask derivatives]</span><br /><br /><b>How is the progress of the task updated?</b><br />When you call publishProgress(...), it results in a call to onProgressUpdate(...) which is running in the GUI thread. Here, you can manipulate any widget like progress bar to indicate the task progress.<br /><br />...<br /><br />This may not be the only way to code AsyncTask, but it certainly has worked for me - not just for one, but for two sizeable projects. Before this, it used to be pretty cumbersome to define a new task.<br /><br />You can download the source code and use it in your app if you like.<br /><br />Any comments and suggestions are welcome.<br /><br /><a href="http://flattr.com/thing/113850/Android-Async-task-template" target="_blank"><br /><img src="http://api.flattr.com/button/flattr-badge-large.png" alt="Flattr this" title="Flattr this" border="0" /></a><br /><br /><br />Ads:<br /><br /><br /><iframe align="left" frameborder="0" marginheight="0" marginwidth="0" scrolling="no" src="http://rcm.amazon.com/e/cm?t=myfreq-20&amp;o=1&amp;p=8&amp;l=bpl&amp;asins=0321627091&amp;fc1=000000&amp;IS2=1&amp;lt1=_blank&amp;m=amazon&amp;lc1=0000FF&amp;bc1=000000&amp;bg1=FFFFFF&amp;f=ifr" style="align: left; height: 245px; padding-right: 10px; padding-top: 5px; width: 131px;"></iframe><iframe align="left" frameborder="0" marginheight="0" marginwidth="0" scrolling="no" src="http://rcm.amazon.com/e/cm?t=myfreq-20&amp;o=1&amp;p=8&amp;l=bpl&amp;asins=1430226595&amp;fc1=000000&amp;IS2=1&amp;lt1=_blank&amp;m=amazon&amp;lc1=0000FF&amp;bc1=000000&amp;bg1=FFFFFF&amp;f=ifr" style="align: left; height: 245px; padding-right: 10px; padding-top: 5px; width: 131px;"></iframe><iframe align="left" frameborder="0" marginheight="0" marginwidth="0" scrolling="no" src="http://rcm.amazon.com/e/cm?t=myfreq-20&amp;o=1&amp;p=8&amp;l=bpl&amp;asins=0470565527&amp;fc1=000000&amp;IS2=1&amp;lt1=_blank&amp;m=amazon&amp;lc1=0000FF&amp;bc1=000000&amp;bg1=FFFFFF&amp;f=ifr" style="align: left; height: 245px; padding-right: 10px; padding-top: 5px; width: 131px;"></iframe></div>
<h2>Comments</h2>
<div class='comments'>
<div class='comment'>
<div class='author'>Anonymous</div>
<div class='content'>
Do each of the tasks you&#39;ve defined (APPTASK_1, _2 etc.) call functions of the same object?<br />I found weird things happening (like some events completing before others even though they were started later) when I used it like this. I guess more checks need to be added if you want to do that.<br /><br />Would be nice if you could show a working example of this with multiple APPTASK&#39;s.</div>
</div>
<div class='comment'>
<div class='author'>chef aprons</div>
<div class='content'>
do you think when it comes to CP Os which is better Android or Bada?</div>
</div>
<div class='comment'>
<div class='author'>Anonymous</div>
<div class='content'>
Thanks for saving me time, perfect example of how to handle AsyncTask.  Saved me a ton of time!</div>
</div>
<div class='comment'>
<div class='author'>Anonymous</div>
<div class='content'>
This is great! Thanks a lot! ;)</div>
</div>
<div class='comment'>
<div class='author'>susicox09</div>
<div class='content'>
The proper work on screen orientation should be done as it is not doing now.</div>
</div>
<div class='comment'>
<div class='author'>Android</div>
<div class='content'>
Hi. Looks like this worked on the Droid X but does not seem to work on the Backflip because of the lack of /etc/firmware. Any ideas?</div>
</div>
<div class='comment'>
<div class='author'>Artjom</div>
<div class='content'>
hi, first really good work you do here. however I have a question. I am facing a problem in working with gps on android. I try to display gps status updates but the main ui thread hangs when I apply the updates to the view. So I consider to use AsyncTask.<br /><br />I have a class that implements LocationListener. There is a method &quot;onLocationChanged&quot; that is fired whenever gps location changes. To be sure that there IS gps data and not some kind of null data a message is sent do a message handler. The handler looks like that:<br /><br />Handler updateHandler = new Handler() {<br />/** Gets called on every message that is received */<br />// @Override<br />public void handleMessage(Message msg) {<br /> switch (msg.what) {<br />    case UPDATE_LOCATION: {<br />    //here I have access to gps data<br />    }<br />  }<br />  super.handleMessage(msg);<br />  }<br />}; <br /><br />Now I wonder how to apply the updates in a async way to the view. hope you can help me<br /><br />thanks</div>
</div>
<div class='comment'>
<div class='author'>Jon</div>
<div class='content'>
actually, i realized that the asynctask isn&#39;t the problem at all. the reason why it was taking so long to do my tasks was because it had problems connecting to a website. simply fixed that with catching a timeout. thanks though :)</div>
</div>
<div class='comment'>
<div class='author'>Jayesh</div>
<div class='content'>
Jon: Maybe this has your answer<br /><br />http://stackoverflow.com/questions/2903476/handling-activity-destruction-in-multithreaded-android-app</div>
</div>
<div class='comment'>
<div class='author'>Jon</div>
<div class='content'>
this method works great, however how would you cancel the asynctask if the user presses home or back?</div>
</div>
<div class='comment'>
<div class='author'>Anonymous</div>
<div class='content'>
It`s very nice. Little code produce big production.</div>
</div>
<div class='comment'>
<div class='author'>Anonymous</div>
<div class='content'>
It seems like you are not dealing with the case where screen orientation changes while background process is going on. If you haven&#39;t tested yet, I bet you&#39;ll get a crash or or other weirdness.</div>
</div>
<div class='comment'>
<div class='author'>(``-_-´´) -- BUGabundo</div>
<div class='content'>
thanks. i&#39;ll see if macno can improve MuSTArd with this :)</div>
</div>
</div>
