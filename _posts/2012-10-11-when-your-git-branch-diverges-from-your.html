---
layout: post
title: "When your git branch diverges from your remote"
date: 2012-10-11
comments: false
categories:
 - git
 - commit
---

<div class='post'>
This is a tricky state and in past when I occasionally got myself into it I could never cleanly recover from it. Until now. I just found a clean way.<br /><br />What's this tricky problem?<br /><br />You know that <code>git commit --amend</code> is a very useful way to make changes to your last commit. You can add a couple of diffs to it or just change the commit message. It works great as long as you haven't pushed that commit to any remote. If the remote already has your last commit and now you make changes to it locally, your local branch and the remote branch are going to diverge. You will get a message like this<br /><br /><pre># On branch master<br /># Your branch and 'origin/master' have diverged,<br /># and have 1 and 1 different commit(s) each, respectively.<br /><br /></pre>If you try to push to remote, git won't let you (if I recall correctly). Therefore I almost always check whether I've pushed the commits to origin/master before I try to invoke --amend. But sometimes accidentally I forget to check and end up in this tight situation. Well today I got a way to resolve it.<br /><br />The state of your git repository is like this<br /><br /><pre>Remote: A --&gt; B<br />&nbsp; &nbsp; &nbsp; &nbsp;  \<br />Local: &nbsp;A --&gt; C<br /><br /></pre>After commit A, you created commit B and pushed it to the remote. Then you accidentally did --amend on commit B and changed it to commit C. Here are the steps to recover.<br /><ol><li>Rewind C. In the past I described <a href="http://jyro.blogspot.in/2012/05/rolling-back-latest-git-commit.html">different ways of undoing a commit</a>. One of them helps us here. We run <code>git reset --soft HEAD^</code>to rewind commit C. That is, the changes in commit C come back to the staged state. Now these changes are sum of the diffs that went in commit B and the changes you added with --amend.&nbsp;</li><li>Note the changes you did in --amend (copy them somewhere, hopefully they weren't many).&nbsp;</li><li>Now either erase these changes with <code>git checkout</code>or stash them away with <code>git stash save</code>.&nbsp;</li><li>Now do a git pull. This will bring your local repo in sync with remote. i.e. your repo's HEAD will now be at commit B.&nbsp;</li><li>Now do the changes that you were trying to commit with <code>--amend</code> (that you saved somewhere earlier).&nbsp;</li><li>Now commit them as a new separate commit D.&nbsp;</li><li>If you had stashed the old mixed changes, do a <code>git stash clear</code> to loose them.</li></ol><div>That's it. Now your local and remote branches will look like this after you push</div><div><br /><pre>Remote: A --&gt; B --&gt; D<br />&nbsp; &nbsp; &nbsp; &nbsp;  <br />Local: &nbsp;A --&gt; B --&gt; D<br /><br /></pre></div><div><br /></div></div>
