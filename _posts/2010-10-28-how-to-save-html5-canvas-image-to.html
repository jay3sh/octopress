---
layout: post
title: "How to save HTML5 canvas image to Google App Engine"
date: 2010-10-28
comments: false
categories:
 - image
 - html5
 - google-app-engine
 - canvas
 - gae
---

<div class='post'>
This is a very specific problem and not many would have it. But I had to implement it and came up with a solution that works for me. This is how I did it for <a href="http://www.3dtin.com/">3DTin</a>.<br /><br />First why it's specific. In a typical case a web app wants to save user submitted images to Google app engine data store. This can be simply done by presenting user with a form and adding an 'input' tag with type 'file'. The submitted image can be extracted in GAE using request.get() and packaged into db.Blob to eventually store into BlobProperty. I am not going to explain this typical case, because it's covered nicely in the&nbsp;<a href="http://code.google.com/appengine/docs/python/images/usingimages.html">GAE's documentation</a>. However, the process is not as straightforward when the image you want to store is not an image file on user's computer, but a dump of HTML5 canvas element in the web app.<br /><br />An HTML5 canvas element lets you export its content as jpeg or png image with the <a href="http://www.w3.org/TR/html5/the-canvas-element.html#dom-canvas-todataurl">toDataURL API</a>. This function returns a data URL that contains base64 encoded jpeg/png image. So how do we convert this image data into GAE's db.Blob object?<br /><br />The solution is to send the base64 encoded data as POST param to GAE app, do some regex matching to extract the exact portion of the data URL that is the encoded image and pass it through the base64 decoder (which is part of standard python library).<br /><br />Here is client side:<br /><script src="http://gist.github.com/651811.js?file=imguploader.js"></script><br /><br />Here is server side code:<br /><script src="http://gist.github.com/651811.js?file=imgsaver.py"></script><br /><br />Code is also accessible as gist <a href="http://gist.github.com/651811">here</a>, in case you can't see the embedded version above.<br /><br />This code works in <a href="http://www.3dtin.com/">3DTin</a> where a thumbnail of user's canvas is sent to GAE app for storage. It works without problem.<br /><br />Ads:<br /><iframe align="left" frameborder="0" marginheight="0" marginwidth="0" scrolling="no" src="http://rcm.amazon.com/e/cm?t=myfreq-20&amp;o=1&amp;p=8&amp;l=bpl&amp;asins=1430227907&amp;fc1=000000&amp;IS2=1&amp;lt1=_blank&amp;m=amazon&amp;lc1=0000FF&amp;bc1=000000&amp;bg1=FFFFFF&amp;f=ifr" style="align: left; height: 245px; padding-right: 10px; padding-top: 5px; width: 131px;"></iframe><iframe align="left" frameborder="0" marginheight="0" marginwidth="0" scrolling="no" src="http://rcm.amazon.com/e/cm?t=myfreq-20&amp;o=1&amp;p=8&amp;l=bpl&amp;asins=0470464933&amp;fc1=000000&amp;IS2=1&amp;lt1=_blank&amp;m=amazon&amp;lc1=0000FF&amp;bc1=000000&amp;bg1=FFFFFF&amp;f=ifr" style="align: left; height: 245px; padding-right: 10px; padding-top: 5px; width: 131px;"></iframe><iframe align="left" frameborder="0" marginheight="0" marginwidth="0" scrolling="no" src="http://rcm.amazon.com/e/cm?t=myfreq-20&amp;o=1&amp;p=8&amp;l=bpl&amp;asins=059652272X&amp;fc1=000000&amp;IS2=1&amp;lt1=_blank&amp;m=amazon&amp;lc1=0000FF&amp;bc1=000000&amp;bg1=FFFFFF&amp;f=ifr" style="align: left; height: 245px; padding-right: 10px; padding-top: 5px; width: 131px;"></iframe><iframe align="left" frameborder="0" marginheight="0" marginwidth="0" scrolling="no" src="http://rcm.amazon.com/e/cm?t=myfreq-20&amp;o=1&amp;p=8&amp;l=bpl&amp;asins=0240813286&amp;fc1=000000&amp;IS2=1&amp;lt1=_blank&amp;m=amazon&amp;lc1=0000FF&amp;bc1=000000&amp;bg1=FFFFFF&amp;f=ifr" style="align: left; height: 245px; padding-right: 10px; padding-top: 5px; width: 131px;"></iframe><iframe align="left" frameborder="0" marginheight="0" marginwidth="0" scrolling="no" src="http://rcm.amazon.com/e/cm?t=myfreq-20&amp;o=1&amp;p=8&amp;l=bpl&amp;asins=0596806027&amp;fc1=000000&amp;IS2=1&amp;lt1=_blank&amp;m=amazon&amp;lc1=0000FF&amp;bc1=000000&amp;bg1=FFFFFF&amp;f=ifr" style="align: left; height: 245px; padding-right: 10px; padding-top: 5px; width: 131px;"></iframe></div>
